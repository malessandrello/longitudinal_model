---
title: "Longitudinal Data Analysis and Modeling"
author: "Mauricio Alessandrello"
fig-cap-location: margin
format: 
  html:
    css: style.css
    toc: TRUE
    toc-location: left
    cap-location: bottom
title-block-banner: "#00524e"
title-block-banner-color: "white"

---

## Summary

The present document is a longitudinal data analysis and modeling report. The dataset used can be obtained from [here](https://e-m-mccormick.github.io/static/longitudinal-primer/07-datasets.html). This dataset contains the dorsolateral prefrontal cortex (DLPFC) activity measured when adolescents (ages 11.74 - 15.33) were subjected to an executive function task. Behavioral scores on that tasks are also included. The measurements were distributed in 4 annually waves. The variables of the dataset are subject identification ('id'), subject sex ('sex'), treatment group ('tx'), annual measures of DLPFC activity during task ('dlpfc'), behavioral score on that task ('ef') and age('age')  

## Dataset Organizing 


```{r load_data, warning=FALSE, message=FALSE}
#Load used libraries
library(tidyverse)
library(readr)
library(lmerTest)
library(rstatix)
library(ggpubr)
library(knitr)

# Load data and transform to long format
executive_function <- read_csv("datasets/executive-function.csv")

# The variables (dlpfc, ef and age) were separated to transform the data in long format.
ex.func_dlpfc <- executive_function %>% 
  select(1:7) %>% 
  pivot_longer(cols = 4:7, names_to = "wave", values_to = "dlpfc") %>% 
  mutate(wave = case_when(wave == "dlpfc1" ~ as_factor(0),
                          wave == "dlpfc2" ~ as_factor(1),
                          wave == "dlpfc3" ~ as_factor(2),
                          wave == "dlpfc4" ~ as_factor(3)),
         id = as.factor(id),
         treatment = ifelse(tx == 0, "Treatment 0", "Treatment 1"))

ex.func_ef <- executive_function %>% 
  select(1:3, 8:11) %>% 
  pivot_longer(cols = 4:7, names_to = "wave", values_to = "ef") %>% 
  mutate(wave = case_when(wave == "ef1" ~ as_factor(0),
                          wave == "ef2" ~ as_factor(1),
                          wave == "ef3" ~ as_factor(2),
                          wave == "ef4" ~ as_factor(3)),
         id = as.factor(id),
         treatment = ifelse(tx == 0, "Treatment 0", "Treatment 1"))

ex.func_age <- executive_function %>% 
  select(1:3, 12:15) %>% 
  pivot_longer(cols = 4:7, names_to = "wave", values_to = "age") %>% 
  mutate(wave = case_when(wave == "age1" ~ as_factor(0),
                          wave == "age2" ~ as_factor(1),
                          wave == "age3" ~ as_factor(2),
                          wave == "age4" ~ as_factor(3)),
         id = as.factor(id),
         treatment = ifelse(tx == 0, "Treatment 0", "Treatment 1"))


# And then were put it all together in a single data frame.
data <- list(ex.func_dlpfc, ex.func_ef, ex.func_age)

full_data <- reduce(data, full_join)
```

## Exploratory Data Analysis

```{r eda, warning=FALSE, message=FALSE}
# Missing values

mean(is.na(full_data))

# Balanced groups?

mean(full_data$sex == 1)

mean(full_data$tx == 1)

full_data_sex1 <- full_data %>% 
  filter(sex == 1)

full_data_sex0 <- full_data %>% 
  filter(sex == 0)  

mean(full_data_sex1$tx == 1)

mean(full_data_sex1$tx == 0)

mean(full_data_sex0$tx == 1)

mean(full_data_sex0$tx == 0)

#Summary statistics of the different variables

#Overall DLPFC activity
dlpfc_stats <- full_data %>%
  select(- treatment) %>% 
  group_by(wave) %>%
  get_summary_stats(dlpfc)

knitr::kable(dlpfc_stats, caption = "Statistics of DLPFC activity across waves")


#DLPFC activity by sex
dlpfc_stats_sex1 <- full_data %>% 
  select(- treatment) %>% 
  group_by(wave) %>%
  filter(sex == 1) %>% 
  get_summary_stats(dlpfc)


knitr::kable(dlpfc_stats_sex1, caption = "Statistics of DLPFC activity for sex = 1 across waves")

dlpfc_stats_sex0 <- full_data %>% 
  select(- treatment) %>% 
  group_by(wave) %>%
  filter(sex == 0) %>% 
  get_summary_stats(dlpfc)

knitr::kable(dlpfc_stats_sex0, caption = "Statistics of DLPFC activity for sex = 0 across waves")

#DLPFC activity by treatment
dlpfc_stats_tx1 <- full_data %>% 
  select(- treatment) %>% 
  group_by(wave) %>%
  filter(tx == 1) %>% 
  get_summary_stats(dlpfc)


knitr::kable(dlpfc_stats_tx1, caption = "Statistics of DLPFC activity for tx = 1 across waves")

dlpfc_stats_tx0 <- full_data %>% 
  select(- treatment) %>% 
  group_by(wave) %>%
  filter(tx == 0) %>% 
  get_summary_stats(dlpfc)


knitr::kable(dlpfc_stats_tx0, caption = "Statistics of DLPFC activity for tx = 0 across waves")



```

***

## Graphical Data Analysis

```{r}
dlpfc_hist <- full_data %>% 
  ggplot(aes(dlpfc))+
  geom_histogram()+
  facet_grid(~wave)
```


```{r graphic1, warning=FALSE, message=FALSE, fig.cap = "There is a statistically significant increase in the DLPFC activity over time, especially when initial and final values are compared." }

# Overall boxplot

dlpfc_box <- full_data %>% 
  ggplot(aes(wave, dlpfc))+
  geom_boxplot()+
  geom_pwc()+
  xlab("Wave")+
  ylab("DLPFC activity")+
  theme_minimal() + 
  theme(legend.position = "none")

dlpfc_box

```

***
```{r graphic2, warning=FALSE, message=FALSE, fig.cap = "In a same wave, the difference in the DLPFC activity between individuals of different sex is bigger for subjects of the treatment 0"}
# Boxplot comparing sex and treatment

dlpfc_box_sex <- full_data %>%
  mutate(sex = as.factor(sex)) %>% 
  ggplot(aes(wave, dlpfc, fill = sex))+
  geom_boxplot()+
  geom_pwc()+
  xlab("Wave")+
  ylab("DLPFC activity")+
  theme_minimal() + 
  theme(legend.position = "bottom",
        strip.text = element_text(face = "bold"))+
  facet_grid(~treatment)

dlpfc_box_sex


```

***

```{r graphic3, warning=FALSE, message=FALSE, fig.cap = "In a same wave, there is no difference in the DLPFC activiy among individuals of the same sex and different treatment"}
# Boxplot comparing treatment and sex

dlpfc_box_tx <- full_data %>%
  ggplot(aes(wave, dlpfc, fill = treatment))+
  geom_boxplot()+
  geom_pwc()+
  xlab("Wave")+
  ylab("DLPFC activity")+
  labs(fill = "Treatment")+
  theme_minimal() + 
  theme(legend.position = "bottom",
        strip.text = element_text(face = "bold"))+
  facet_grid(~sex, labeller = as_labeller(c("0" = "sex 0", "1" = "sex 1")))

dlpfc_box_tx

```

***

```{r graphic4, warning=FALSE, message=FALSE, fig.cap = "The treatment = 0 sex = 0 and the treatment = 1 and sex = 1 combinations showed less statistical significance when comparing initial and final DLPFC values. Probably, because of smaller sample size."}
# Boxplot comparing treatment and sex

dlpfc_box_tx2 <- full_data %>%
  mutate(sex = as.factor(sex)) %>% 
  ggplot(aes(wave, dlpfc))+
  geom_boxplot()+
  geom_pwc(label.size = 2.7)+
  xlab("Wave")+
  ylab("DLPFC activity")+
  theme_minimal() + 
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))+
  facet_grid(sex~treatment, labeller = as_labeller(c("0" = "Sex 0", "1" = "Sex 1",
                                              "Treatment 0" = "Treatment 0",
                                              "Treatment 1" = "Treatment 1")))

dlpfc_box_tx2

```